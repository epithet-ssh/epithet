---
yatl_version: 0
title: 'CA client: Link header parsing'
id: ca6m9e62
created: 2025-12-14T05:18:42.889462Z
updated: 2025-12-24T23:06:05.725688Z
author: Brian McCallister
priority: medium
tags:
- protocol
- ca-client
- discovery
blocked_by:
- eg21yfrr
- xhr5v2pc
---

Parse Link header from CA responses to extract discovery URL.

File: pkg/caclient/caclient.go

Implementation:
- parseLinkHeader() to extract rel=discovery URL (RFC 8288)
- getDiscoveryURL(headers) helper
- FetchDiscovery(url, token) to fetch discovery data
- All response methods return http.Header for Link access

---
## Log

---
# Log: 2025-12-14T05:18:42Z Brian McCallister

Created task.
---
# Log: 2025-12-14T05:18:51Z Brian McCallister

Implementation details:

Link header parsing (RFC 8288):
  Link: <https://discovery.example.com/abc123>; rel="discovery"

func parseLinkHeader(header string) map[string]string {
    // Returns map of rel -> URL
    // Parse format: <URL>; rel="name"; other="params"
    // Return map["discovery"] = "https://discovery.example.com/abc123"
}

Helper to extract discovery URL:
func getDiscoveryURL(headers http.Header) string {
    linkHeader := headers.Get("Link")
    links := parseLinkHeader(linkHeader)
    return links["discovery"]
}

Fetch discovery from URL:
func (c *Client) FetchDiscovery(url string, token []byte) (*Discovery, error) {
    encoded := base64.RawURLEncoding.EncodeToString(token)
    req, _ := http.NewRequest("GET", url, nil)
    req.Header.Set("Authorization", "Bearer " + encoded)
    // ... fetch and parse JSON
}

type Discovery struct {
    MatchPatterns []string `json:"matchPatterns"`
}

All CA response methods should return headers so caller can access Link header.
---
# Log: 2025-12-14T05:18:55Z Brian McCallister

Added blocker: eg21yfrr
---
# Log: 2025-12-14T05:18:55Z Brian McCallister

Added blocker: xhr5v2pc
---
# Log: 2025-12-24T22:51:20Z Brian McCallister

Started working.

---
# Log: 2025-12-24T23:00:58Z Brian McCallister

Starting implementation: parseLinkHeader, CertResponse, GetDiscovery

---
# Log: 2025-12-24T23:06:01Z Brian McCallister

Implementation complete: parseLinkHeader, CertResponse, GetDiscovery. Updated broker and tests.

---
# Log: 2025-12-24T23:06:05Z Brian McCallister

Closed: Implemented CA client Link header parsing: parseLinkHeader (internal), CertResponse type with DiscoveryURL, GetDiscovery method that validates token and fetches discovery data. Updated broker to use CertResponse. All tests pass.
