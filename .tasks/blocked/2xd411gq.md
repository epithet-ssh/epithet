---
title: 'Policy Server - Bearer Auth Header: Update policy server to accept token in Authorization header. Files: pkg/policyserver/policyserver.go, pkg/ca/ca.go, cmd/epithet/policy.go. Policy server extracts token from header, CA passes token in header to policy server, remove token from policy request body.'
id: 2xd411gq
created: 2025-12-14T05:17:19.364276Z
updated: 2025-12-14T17:36:08.835345Z
author: Brian McCallister
priority: medium
tags:
- protocol
- policy-server
blocked_by:
- mc0d1e7n
---

---
## Log

---
# Log: 2025-12-14T05:17:19Z Brian McCallister

Created task.
---
# Log: 2025-12-14T05:17:26Z Brian McCallister

Implementation details:

Policy server side (pkg/policyserver/policyserver.go):
- Parse 'Authorization: Bearer <token>' header
- Token validation happens here (OIDC, etc.)
- Remove token from request body struct

CA calling policy server (pkg/ca/ca.go):
- In RequestPolicy(), set Authorization header when calling policy server
- req.Header.Set("Authorization", "Bearer " + token)
- Remove token from JSON body sent to policy server

Policy request body becomes:
  type PolicyRequest struct {
      Signature  string            `json:"signature"`
      Connection policy.Connection `json:"connection,omitempty"`
  }

Note: Connection is optional - if nil, it's a validation-only request (for hello flow)
---
# Log: 2025-12-14T05:17:30Z Brian McCallister

Added blocker: mc0d1e7n
---
# Log: 2025-12-14T17:35:39Z Brian McCallister

DESIGN CHANGE: Policy server auth is now different from broker->CA auth.

NEW PROTOCOL (CA -> Policy Server):
- Authorization: Bearer <base64_sshsig_of_body>
- Body: {"token": "<user_token>", "connection": {...}}

Policy server:
1. Extracts signature from Authorization Bearer header
2. Reads body bytes
3. Verifies signature against body using CA public key
4. Extracts user token from body JSON
5. Validates user token (OIDC, etc.)

This is NOT the user token in the header - it's the CA's signature proving request authenticity.
---
# Log: 2025-12-14T17:36:08Z Brian McCallister

CODE CHANGE NEEDED in pkg/policyserver/policyserver.go:

CURRENT Request struct:
  Token      string
  Signature  string  // REMOVE - moves to header
  Connection policy.Connection

NEW Request struct:
  Token      string
  Connection policy.Connection

Signature comes from Authorization: Bearer header, verified against body bytes.
