---
title: 'Broker: Discovery caching'
id: 1827k84k
created: 2025-12-14T05:19:01.145682Z
updated: 2025-12-14T17:39:31.701611Z
author: Brian McCallister
priority: medium
tags:
- broker
- discovery
blocked_by:
- ca6m9e62
---

Cache discovery data in broker, track URL changes.

Files: pkg/broker/broker.go, pkg/broker/discovery.go (new)

Implementation:
- Store discovery URL and patterns in broker state
- After any CA response, check if URL changed
- Fetch new discovery if URL changed
- Use cached patterns for match short-circuit

---
## Log

---
# Log: 2025-12-14T05:19:01Z Brian McCallister

Created task.
---
# Log: 2025-12-14T05:19:09Z Brian McCallister

Implementation details:

New file pkg/broker/discovery.go:

type DiscoveryCache struct {
    mu            sync.RWMutex
    url           string      // Current discovery URL (content-addressable)
    patterns      []string    // Cached match patterns
}

func (d *DiscoveryCache) NeedsRefresh(newURL string) bool {
    d.mu.RLock()
    defer d.mu.RUnlock()
    return d.url != newURL
}

func (d *DiscoveryCache) Update(url string, patterns []string) {
    d.mu.Lock()
    defer d.mu.Unlock()
    d.url = url
    d.patterns = patterns
}

In pkg/broker/broker.go:

Add discovery cache to Broker struct:
  type Broker struct {
      // ... existing fields
      discovery *DiscoveryCache
  }

After any CA response (hello, cert, error):
1. Extract Link header using caclient.getDiscoveryURL()
2. If discovery.NeedsRefresh(url): fetch new discovery
3. Update cache with new patterns

Bootstrap flow (first request):
1. No patterns cached -> make hello request
2. Get Link header from response
3. Fetch discovery from URL
4. Cache patterns
5. Now can short-circuit on subsequent matches
---
# Log: 2025-12-14T05:19:14Z Brian McCallister

Added blocker: ca6m9e62